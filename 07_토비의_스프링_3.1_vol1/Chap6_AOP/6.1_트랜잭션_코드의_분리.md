> **ğŸ’¡Â ìŠ¤í”„ë§ 3ëŒ€ ê¸°ìˆ **
>- IoC / DI (ì˜ì¡´ì„± ì—­ì „)
>- ì„œë¹„ìŠ¤ ì¶”ìƒí™”
>- AOP

[ì„œë¹„ìŠ¤ ì¶”ìƒí™”](https://yangbongsoo.gitbook.io/study/spring-1/service_abstraction)

- AOPì˜ ë“±ì¥ ë°°ê²½, ìŠ¤í”„ë§ì´ ë„ì…í•œ ì´ìœ , ì ìš©ì„ í†µí•´ ì–»ì„ ìˆ˜ ìˆëŠ” ì´ì 
- AOPì˜ ê°€ì¹˜ì™€ íš¨ê³¼ì ìœ¼ë¡œ ì‚¬ìš©í•  ë°©ë²•
- AOPì˜ ë„¤ì„ë“œ ì ìš© ëŒ€ìƒ : ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê¸°ëŠ¥
    - ì„œë¹„ìŠ¤ ì¶”ìƒí™”ë¥¼ í†µí•´ ë§ì€ ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ í•´ê²°í•œ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ê¸°ëŠ¥

# 6.1 íŠ¸ëœì­ì…˜ ì½”ë“œì˜ ë¶„ë¦¬

- íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì „í›„ì— ì„¤ì •ë˜ì–´ì•¼í•¨. UserServiceì—ì„œ ê±·ì–´ë‚´ê³  ì‹¶ë‹¤!

## 6.1.1 ë©”ì†Œë“œ ë¶„ë¦¬

```java
public void upgradeLevels() throws Exception {
	 // íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
	TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
	
	try {

		//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œ
		List<User> users = userDao.getAll();
		for (User user: users) {
			if (canUpgradeLevel(user)) {
				upgradeLevel(user);
			}
		}

		// íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
		this.transactionManager.commit(status); 
	} catch (Exception e) {
			 // íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
			this.transactionManager.rollback(status);
			throw e;
	}
}
```

- ì–½íŒ ê²ƒ ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì½”ë“œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆìŒ
- íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •ì˜ ì½”ë“œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œ ê°„ì— ì„œë¡œ ì£¼ê³ ë°›ëŠ” ì •ë³´ê°€ ì—†ìŒ
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ DB ì»¤ë„¥ì…˜ ì •ë³´ë¥¼ ì§ì ‘ ë³¼ ì¼ì€ ì—†ìŒ
    - íŠ¸ëœì­ì…˜ ì •ë³´ëŠ” DAOê°€ ì•Œì•„ì„œ í™œìš©í•¨

â‡’ ë‘˜ì€ ì™„ì „íˆ ë…ë¦½ì ì¸ ì½”ë“œì´ë‹¤! â‡’ ë¶„ë¦¬í• ê¹Œ?!

```java
// íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
public void upgradeLevels() throws Exception {	 
	TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
	
	try {
		upgradeLevelsInternal();
		this.transactionManager.commit(status); 
	} catch (Exception e) {
			this.transactionManager.rollback(status);
			throw e;
	}
}

// ë¶„ë¦¬ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œ, íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ê¸° ì „ê³¼ ë™ì¼í•¨
private void upgradeLevelsInternal(){
	//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œ
	List<User> users = userDao.getAll();
	for (User user: users) {
		if (canUpgradeLevel(user)) {
			upgradeLevel(user);
		}
	}
}
```

## 6.1.2 DIë¥¼ ì´ìš©í•œ í´ë˜ìŠ¤ì˜ ë¶„ë¦¬

- ê·¸ë˜ë„ ì•„ì§ `UserService`ì— íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œê°€ ìˆë‹¤. ì ì–´ë„ ì´ í´ë˜ìŠ¤ ì•ˆì—ì„œëŠ” ëº„ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?

### DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬

- ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë¬¸ì œë¼ë©´ ê°„ì ‘ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ë¨! â†’ *DI*
- ì‹¤ì œë¡œ ì‚¬ìš©í•  ì˜¤ë¸Œì íŠ¸ì˜ í´ë˜ìŠ¤ ì •ì²´ëŠ” ê°ì¶˜ ì±„ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ê°„ì ‘ìœ¼ë¡œ ì ‘ê·¼í•¨

< Before >

![Untitled](../img/Chap6/Untitled.png)

< After >

![Untitled](../img/Chap6/Untitled%201.png)

- êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë°”ê¾¸ê¸° ìœ„í•´ DIë¥¼ ì ìš©í•˜ì—¬ ì‚¬ìš©í•¨
- í•œ ë²ˆì— ë‘ ê°œì˜ UserService ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ë¥¼ ì´ìš©í•œë‹¤ë©´????

  ![Untitled](../img/Chap6/Untitled%202.png)

    - íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì±…ì„ì„ ìœ„í•œ êµ¬í˜„ì²´ë¥¼ í•˜ë‚˜ ë” ë§Œë“ ë‹¤
    - íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • â†’ ì‹¤ì§ˆì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ì²˜ë¦¬ ìœ„ì„ í˜¸ì¶œ â†’ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
    - íŠ¸ëœì­ì…˜ê¹Œì§€ ì ìš©ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ êµ¬í˜„

### UserService ì¸í„°í˜ì´ìŠ¤ ë„ì…

- ë¡œì§ì€ Implì—ì„œ êµ¬í˜„í•˜ê³  `UserService`ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¦

```java
public interface UserService {
	void add(User user);
	void upgradeLevels();
}
```

```java
// íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ì œê±°í•œ UserService êµ¬í˜„ í´ë˜ìŠ¤
public class UserServiceImpl implements UserService {
	UserDao userDao;
	MailSender mailSender;

	public void upgradeLevels() {
		List<User> users = userDao.getAll();
		for (User user: users) {
			if (canUpgradeLevel(user)) {
				upgradeLevel(user);
			}
		}
	}
	...
}
```

### ë¶„ë¦¬ëœ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥

```java
// íŠ¸ëœì­ì…˜ì´ ì ìš©ëœ UserServiceTx
public class UserServiceTx implements UserService {
	UserService userService;
	PlatformTransactionManager transactionManager;
	
	public void setTransactionManager(PlatformTransactionManager transactionManager) {
		this.transactionManager = transactionManager;
	}

	// UserServiceë¥¼ êµ¬í˜„í•œ ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ë¥¼ DI ë°›ìŒ
	public void setUserService(UserService userService) {
		this.userService = userService;
	}

	// DI ë°›ì€ UserService ì˜¤ë¸Œì íŠ¸ì— ëª¨ë“  ê¸°ëŠ¥ì„ ìœ„ì„
	public void add(User user) {
		this.userService.add(user);
	}

	// DI ë°›ì€ UserService ì˜¤ë¸Œì íŠ¸ì— ëª¨ë“  ê¸°ëŠ¥ì„ ìœ„ì„
	public void upgradeLevels() {
		TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
		try {
			this.userService.upgradeLevels();
			this.transactionManager.commit(status);
		} catch (RuntimeException e) {
				this.transactionManager.rollback(status);
				throw e;
		}	
	}
}
```

- ê¸°ë³¸ì ìœ¼ë¡œ `UserSerivce`ë¥¼ êµ¬í˜„í•¨
- ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì—ê²Œ ê³ ìŠ¤ë€íˆ ì‘ì—…ì„ ìœ„ì„
- transactionManager : ì¶”ìƒí™”ëœ íŠ¸ëœì­ì…˜ êµ¬í˜„ ì˜¤ë¸Œì íŠ¸ë¥¼ DI ë°›ì„ ìˆ˜ ìˆìŒ

### íŠ¸ëœì­ì…˜ ì ìš©ì„ ìœ„í•œ DI ì„¤ì •

- ì„¤ì •íŒŒì¼ ìˆ˜ì •

![Untitled](../img/Chap6/Untitled%203.png)

- `UserServiceTx` - `transactionManager`
- `UserServiceImpl` - `userDao,` `mailSender`

![Untitled](../img/Chap6/Untitled%204.png)

### íŠ¸ëœì­ì…˜ ë¶„ë¦¬ì— ë”°ë¥¸ í…ŒìŠ¤íŠ¸ ìˆ˜ì •

- ê¸°ì¡´ì˜ UserService í´ë˜ìŠ¤ê°€ ì¸í„°í˜ì´ìŠ¤ì™€ ë‘ ê°œì˜ í´ë˜ìŠ¤(`UserServiceTx`, `UserServiceImpl`)ë¡œ ë¶„ë¦¬ë¨
    - ê¸°ì¡´ì˜ ë¹ˆì€ `@Autowired`ë¡œ DI í•´ê²°
    - `@Autowired` ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íƒ€ì…ì´ ì¼ì¹˜í•˜ëŠ” ë¹ˆì„ ì°¾ì•„ì£¼ê¸°ì— ë¬¸ì œê°€ ë°œìƒí•¨ (ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ê°€ 2ê°œë¼)
    - íƒ€ì…ì´ ì•ˆë§ìœ¼ë©´ í•„ë“œ ëª…ì„ ì´ìš©í•´ ë¹ˆì„ ì°¾ìŒ
- ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ì´ìš©í•´ ìˆ˜ë™ DIë¥¼ ì ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¼ë©´, ì–´ë–¤ í´ë˜ìŠ¤ì˜ ì˜¤ë¸Œì íŠ¸ì¸ì§€ ë¶„ëª…í•˜ê²Œ ì•Œ í•„ìš”ê°€ ìˆìŒ
- í•´ë‹¹ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§„ ë¹ˆì„ ì£¼ì…ë°›ë„ë¡ í•´ì•¼í•¨

```java
@Test
public void upgradeAllOrNothing() throws Exception {
	TestUSerService testUserSerivce = new TestUserService(users.get(3).getId());
	testUserSerivce.setUserDao(userDao);
	testUserSerivce.setMailSender(mailSender);
	
	UserServiceTx txUserService = new USerServiceTx();
	txUserService.setTransactionManager(transactionManager);
	txUSerService.setUserService(testUserService);

	userDao.deleteAll();
	for(User user : users) userDao.add(user);
	try{
		txUserService.upgradeLevels();
		fail("TestServiceException expecte");
	}
	...
		
}
```

### íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì 

1. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë‹´ë‹¹í•˜ëŠ” `UserServiceImpl`ì˜ ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ê¸°ìˆ ì ì¸ ë‚´ìš©ì€ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ë¨
2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì†ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŒ
